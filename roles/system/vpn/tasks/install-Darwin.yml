---
- name: Register MAS installed apps
  command: mas list
  register: mas_list
  changed_when: false

- name: Ensure VPN connections are removed if configured to do so
  copy:
    src: "{{ system_connections_path }}"
    dest: "{{ system_connections_path }}.old"
    mode: preserve
  when: remove_vpn_connections | bool

- name: "Ensure {{ app_name }} is installed"
  command: "mas install '{{ wireguard_mas_id }}'"
  args:
    creates: "/Applications/WireGuard.app"
  when: (wireguard_mas_id | string) not in mas_list.stdout

- name: "Ensure {{ app_name }}'s configuration directory exists"
  file:
    path: "{{ wireguard_conf_dir }}"
    state: directory
    mode: 0600
# TODO: Fix this and add it back in
# - name: Copy WireGuard connection file
#   copy:
#     src: "files/vpn/{{ vpn_connection.file }}"
#     dest: "{{ wireguard_conf_dir }}/{{ vpn_connection.file | regex_replace('.nmconnection$', '.conf')  }}"
#     owner: root
#     mode: 0600
#   when: '"nmconnection" in vpn_connection.file'
